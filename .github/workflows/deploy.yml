name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup VPS and Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 190.7.234.37
          username: root
          password: YmUeXJYrO3
          port: 22
          command_timeout: 30m
          script: |
            echo "ğŸ”§ Verificando dependencias..."

            # Verificar Docker
            if ! command -v docker &> /dev/null; then
              echo "ğŸ“¦ Instalando Docker..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sh get-docker.sh
              rm get-docker.sh
            else
              echo "âœ… Docker ya estÃ¡ instalado"
            fi

            # Instalar Git si no existe
            if ! command -v git &> /dev/null; then
              echo "ğŸ“¦ Instalando Git..."
              apt update && apt install -y git
            else
              echo "âœ… Git ya estÃ¡ instalado"
            fi

            # Verificar versiones
            echo "ğŸ“‹ Versiones instaladas:"
            docker --version
            docker compose version
            git --version

            # Configurar directorio del proyecto
            PROJECT_DIR="/opt/valentine-tree"

            # Crear directorio si no existe
            mkdir -p $PROJECT_DIR
            cd $PROJECT_DIR

            # Si el repo no existe, clonarlo
            if [ ! -d ".git" ]; then
              echo "ğŸ“¦ Clonando repositorio..."
              git clone https://github.com/rhernandezbas/tree_test.git .
            else
              echo "ğŸ”„ Actualizando repositorio..."
              git fetch origin
              git reset --hard origin/main
              git pull origin main
            fi

            # Crear archivo .env si no existe
            if [ ! -f ".env" ]; then
              echo "ğŸ“ Creando archivo .env..."
              if [ -f ".env.example" ]; then
                cp .env.example .env
              else
                echo "âš ï¸  No existe .env.example, creando .env bÃ¡sico..."
                touch .env
              fi
            fi

            # Detener contenedores existentes
            echo "ğŸ›‘ Deteniendo contenedores..."
            docker compose down -v 2>/dev/null || true

            # Limpiar cachÃ© de Docker completamente
            echo "ğŸ§¹ Limpiando cachÃ© de Docker..."
            docker system prune -af --volumes

            # Construir y levantar con los nuevos cambios
            echo "ğŸ—ï¸  Construyendo nueva imagen..."
            if ! docker compose build --no-cache --pull; then
              echo "âŒ Error en el build"
              docker compose logs
              exit 1
            fi

            echo "ğŸš€ Iniciando contenedores..."
            if ! docker compose up -d; then
              echo "âŒ Error al iniciar contenedores"
              docker compose logs
              exit 1
            fi

            # Esperar a que el contenedor estÃ© listo
            echo "â³ Esperando que el servicio estÃ© listo..."
            sleep 20

            # Mostrar estado detallado
            echo "ğŸ“Š Estado de contenedores:"
            docker compose ps -a

            # Mostrar logs completos si hay error
            if ! docker compose ps | grep -q "Up"; then
              echo "âŒ Los contenedores no estÃ¡n corriendo. Logs completos:"
              docker compose logs
              exit 1
            fi

            # Mostrar logs recientes
            echo "ğŸ“‹ Ãšltimos logs:"
            docker compose logs --tail=50

            echo "âœ… Despliegue completado exitosamente"

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 190.7.234.37
          username: root
          password: YmUeXJYrO3
          port: 22
          script: |
            cd /opt/valentine-tree

            # Verificar que los contenedores estÃ¡n corriendo
            echo "ğŸ“Š Estado detallado de contenedores:"
            docker compose ps -a

            if docker compose ps | grep -q "Up"; then
              echo "âœ… Contenedores corriendo correctamente"
              echo ""
              echo "ğŸŒ AplicaciÃ³n disponible en: http://190.7.234.37:30082"
              echo ""
              echo "ğŸ“‹ Logs de la aplicaciÃ³n:"
              docker compose logs --tail=20

              # Test de conectividad
              echo ""
              echo "ğŸ” Probando conectividad..."
              if curl -f http://localhost:30082 > /dev/null 2>&1; then
                echo "âœ… AplicaciÃ³n responde correctamente"
              else
                echo "âš ï¸  AplicaciÃ³n no responde aÃºn"
              fi
              exit 0
            else
              echo "âŒ Error: Contenedores no estÃ¡n corriendo"
              echo ""
              echo "ğŸ“‹ Logs completos:"
              docker compose logs
              echo ""
              echo "ğŸ” Inspeccionando contenedor:"
              docker compose ps -a
              exit 1
            fi

      - name: Health check
        run: |
          echo "ğŸ¥ Verificando salud del servicio..."
          sleep 10
          # Opcional: agregar curl para verificar endpoint
          # curl -f http://190.7.234.37:30082 || exit 1
          echo "âœ… Health check completado"
